# JMMï¼ˆJavaå†…å­˜æ¨¡å‹ï¼‰

## Happens-Beforeè§„åˆ™

ã€ŠJSR-133ï¼šJava Memory Model and Thread Specificationã€‹ä¸­å¯¹happens-beforeå…³ç³»çš„å®šä¹‰å¦‚ä¸‹ï¼š

> (1) å¦‚æœä¸€ä¸ªæ“ä½œhappens-beforeå¦ä¸€ä¸ªæ“ä½œï¼Œé‚£ä¹ˆç¬¬ä¸€ä¸ªæ“ä½œçš„æ‰§è¡Œç»“æœå°†å¯¹ç¬¬äºŒä¸ªæ“ä½œå¯è§ï¼Œè€Œä¸”ç¬¬ä¸€ä¸ªæ“ä½œçš„æ‰§è¡Œé¡ºåºæ’åœ¨ç¬¬äºŒä¸ªæ“ä½œä¹‹å‰ã€‚

> (2) ä¸¤ä¸ªæ“ä½œä¹‹é—´å­˜åœ¨happens-beforeå…³ç³»ï¼Œå¹¶ä¸æ„å‘³ç€Javaå¹³å°çš„å…·ä½“å®ç°å¿…é¡»è¦æŒ‰ç…§happens-beforeå…³ç³»æŒ‡å®šçš„é¡ºåºæ¥æ‰§è¡Œã€‚å¦‚æœé‡æ’åºä¹‹åçš„æ‰§è¡Œç»“æœä¸æŒ‰
happens-beforeå…³ç³»æ¥æ‰§è¡Œçš„ç»“æœä¸€è‡´ï¼Œé‚£ä¹ˆè¿™ç§é‡æ’åºå¹¶ä¸éæ³•ï¼ˆä¹Ÿå³æ˜¯è¯´ï¼ŒJMMå…è®¸è¿™ç§é‡æ’åºï¼‰

ä»¥ä¸Š(1)æ˜¯JMMå¯¹ç¨‹åºå‘˜çš„æ‰¿è‹¥ï¼Œ(2)æ˜¯JMMå¯¹ç¼–è¯‘å™¨å’Œå¤„ç†å™¨é‡æ’åºçš„çº¦æŸåŸåˆ™ã€‚

ã€ŠJSR-133ï¼šJava Memory Model and Thread Specificationã€‹å®šä¹‰äº†å¦‚ä¸‹happens-beforeè§„åˆ™ï¼š

* (1) ç¨‹åºé¡ºåºè§„åˆ™ï¼šä¸€ä¸ªçº¿ç¨‹ä¸­ï¼ŒæŒ‰ç…§ç¨‹åºé¡ºåºï¼Œå‰é¢çš„æ“ä½œ happens-before äºè¯¥çº¿ç¨‹ä¸­åç»­çš„ä»»æ„æ“ä½œã€‚

* (2) volatileå˜é‡è§„åˆ™ï¼šå¯¹ä¸€ä¸ªvolatileåŸŸçš„å†™æ“ä½œï¼Œhappens-before äºåç»­å¯¹è¿™ä¸ªvolatileåŸŸçš„è¯»æ“ä½œã€‚

* (3) ä¼ é€’æ€§è§„åˆ™ï¼šå¦‚æœ A happens-before Bï¼Œä¸” B happens-before Cï¼Œé‚£ä¹ˆ A happens-before Cã€‚

* (4) ç›‘è§†å™¨é”è§„åˆ™ï¼šå¯¹ä¸€ä¸ªé”çš„è§£é”ï¼Œhappens-before äºåç»­å¯¹è¿™ä¸ªé”çš„åŠ é”ã€‚

* (5) start()è§„åˆ™ï¼šå¦‚æœçº¿ç¨‹Aæ‰§è¡Œæ“ä½œThreadB.start()ï¼ˆå³åœ¨çº¿ç¨‹Aä¸­å¯åŠ¨çº¿ç¨‹Bï¼‰ï¼Œé‚£ä¹ˆçº¿ç¨‹Açš„ThreadB.start()æ“ä½œ happens-before äºçº¿ç¨‹Bä¸­çš„ä»»æ„æ“ä½œã€‚ä¹Ÿå³çº¿ç¨‹Bèƒ½å¤Ÿçœ‹åˆ°çº¿ç¨‹Aåœ¨å¯åŠ¨çº¿ç¨‹Bå‰çš„æ“ä½œã€‚

* (6) join()è§„åˆ™ï¼šå¦‚æœçº¿ç¨‹Aæ‰§è¡Œæ“ä½œThreadB.join()å¹¶æˆåŠŸè¿”å›ï¼Œé‚£ä¹ˆçº¿ç¨‹Bä¸­çš„ä»»æ„æ“ä½œ happens-before äºçº¿ç¨‹Aä»ThreadB.join()æ“ä½œæˆåŠŸè¿”å›ã€‚ä¹Ÿå³çº¿ç¨‹Bå®Œæˆåï¼ˆä»çº¿ç¨‹Aä¸­join()è¿”å›ï¼‰ï¼Œçº¿ç¨‹Aèƒ½å¤Ÿçœ‹åˆ°çº¿ç¨‹Bçš„æ“ä½œã€‚


## volatileå˜é‡è§„åˆ™å›¾è§£

![volatileè§„åˆ™å›¾è§£](../img/volatile-rule.png)

> 1 happens-before 2 å’Œ 3 happens-before 4 ç”±ç¨‹åºé¡ºåºè§„åˆ™äº§ç”Ÿï¼›2 happens-before 3 ç”±volatileè§„åˆ™äº§ç”Ÿï¼Œæ‰€ä»¥ 1 happens-before 4 æ˜¯ç”±ä¼ é€’æ€§è§„åˆ™äº§ç”Ÿã€‚

## ç›‘è§†å™¨é”è§„åˆ™å›¾è§£

![ç›‘è§†å™¨é”è§„åˆ™å›¾è§£](../img/synchronized-rule.png)

> 1->2ã€2->3ã€4->5ã€5->6 ç”±ç¨‹åºé¡ºåºè§„åˆ™äº§ç”Ÿï¼›3 happens-before 4 ç”±ç›‘è§†å™¨é”è§„åˆ™äº§ç”Ÿï¼›æ ¹æ®ä¼ é€’æ€§ï¼Œå°†æœ‰ 2 happens-before 5ã€‚è¿™ä¹Ÿæ„å‘³ç€çº¿ç¨‹Aåœ¨é‡Šæ”¾é”ä¹‹å‰æ‰€æœ‰å¯è§çš„å…±äº«å˜é‡ï¼Œåœ¨çº¿ç¨‹Bè·å–åŒä¸€ä¸ªé”ä¹‹åï¼Œå°†ç«‹å³å˜å¾—å¯¹çº¿ç¨‹Bå¯è§ã€‚

## start()è§„åˆ™å›¾è§£

![start()è§„åˆ™å›¾è§£](../img/start-rule.png)

> 1 happens-before 2 ç”±ç¨‹åºé¡ºåºè§„åˆ™äº§ç”Ÿï¼›2 happens-before 4 ç”±start()è§„åˆ™äº§ç”Ÿï¼›æ ¹æ®ä¼ é€’æ€§ï¼Œå°†æœ‰ 1 happens-before 4ã€‚è¿™ä¹Ÿæ„å‘³ç€çº¿ç¨‹Aåœ¨æ‰§è¡ŒThreadB.start()ä¹‹å‰å¯¹å…±äº«å˜é‡æ‰€åšçš„ä¿®æ”¹ï¼Œæ¥ä¸‹æ¥åœ¨çº¿ç¨‹Bå¼€å§‹æ‰§è¡Œåéƒ½å°†ç¡®ä¿å¯¹çº¿ç¨‹Bå¯è§ã€‚

ğŸ‘‰ [ç‚¹å‡»æŸ¥çœ‹ StartExample ç¤ºä¾‹ä»£ç ](../../java/org/concurrency/happensbefore/StartExample.java)

## join()è§„åˆ™å›¾è§£

![join()è§„åˆ™å›¾](../img/join-rule.png)

> 2 happens-before 4 ç”±join()è§„åˆ™äº§ç”Ÿï¼›4 happens-before 5 ç”±ç¨‹åºé¡ºåºè§„åˆ™äº§ç”Ÿï¼›æ ¹æ®ä¼ é€’æ€§ï¼Œå°†æœ‰ 2 happens-before 5ã€‚è¿™ä¹Ÿæ„å‘³ç€çº¿ç¨‹Aæ‰§è¡Œæ“ä½œThreadB.join()å¹¶æˆåŠŸè¿”å›åï¼Œçº¿ç¨‹Bä¸­çš„ä»»æ„æ“ä½œéƒ½å¯¹çº¿ç¨‹Aå¯è§ã€‚

ğŸ‘‰ [ç‚¹å‡»æŸ¥çœ‹ JoinExample ç¤ºä¾‹ä»£ç ](../../java/org/concurrency/happensbefore/JoinExample.java)